import{a as le}from"./chunk-BJZLS4P7.js";import{a as se,e as me}from"./chunk-INPKZIN2.js";import{b as ae}from"./chunk-XDLC4A3K.js";import{j as $,q as ie,r as re,v as ce}from"./chunk-4NITVLUQ.js";import{B as d,Ea as X,F as H,Fa as x,G as u,H as f,Ha as C,J as K,Ja as c,Kb as oe,O as b,P as I,Q as W,Va as T,Wa as P,Xa as Y,Y as h,Ya as Z,ba as v,bb as ee,cb as U,db as L,fb as N,ga as G,gb as q,ib as k,jb as te,mb as ne,pa as O,qa as V,sa as Q,ta as F,tb as B,ua as S,va as g,vb as M,wa as l,wb as a,x as R,xa as p}from"./chunk-VOU2RNQA.js";import{a as y,b as J}from"./chunk-FDERIQAA.js";var he=()=>[],pe=()=>({}),ge=(o,s,e,t,n,i,r,m,_,w,D,fe,_e)=>({props:o,config:s,component:e,wFormId:t,wFormKey:n,wSubmit:i,wChange:r,wClick:m,model:_,fieldTree:w,field:D,submition:fe,key:_e}),Ce=o=>({$implicit:o}),be=(o,s)=>s.key??o;function we(o,s){if(o&1){let e=x();l(0,"form-component",3),C("wSubmit",function(){u(e);let n=c(3);return f(n.wSubmit.emit(n.submition()||{}))})("wChange",function(){u(e);let n=c(3);return f(n.wChange.emit())})("wClick",function(){u(e);let n=c(3);return f(n.wClick.emit())}),p()}if(o&2){let e=c(),t=e.$implicit,n=e.$index,i=c(2);T(q("wformc__item ",i.formId()," ",i.formId()+"_"+i.index()+"_"+n," ",t.class||"")),g("formId",i.formId())("component",t)("config",i.config())("submition",i.submition())("model",i.model())("fieldTree",i.fieldTree())("index",i.index()+"_"+n)}}function ve(o,s){if(o&1&&O(0,we,1,12,"form-component",2),o&2){let e=s.$implicit;V(e.hidden?-1:0)}}function xe(o,s){if(o&1&&(l(0,"div"),F(1,ve,1,1,null,null,be),p()),o&2){let e=c();T(N("wformc ",e.component().class||"")),h(),S(e.component().components??k(3,he))}}function ye(o,s){o&1&&X(0)}function Me(o,s){if(o&1&&(l(0,"div",1),G(1,ye,1,0,"ng-container",4),p()),o&2){let e=c();h(),g("ngTemplateOutlet",e.template())("ngTemplateOutletContext",te(18,Ce,ne(4,ge,[e.component().props||k(2,pe),e.config(),e.component(),e.formId(),e.effectiveKey(),e.submit.bind(e),e.change.bind(e),e.click.bind(e),e.model(),e.fieldTree(),e.field,e.submition()||k(3,pe),e.effectiveKey()])))}}var de=(()=>{class o{constructor(){this._form=d(E),this.index=a("",{}),this.formId=a("",{}),this.config=a.required({}),this.component=a.required({}),this.submition=a({},{}),this.model=a(null,{}),this.fieldTree=a(null,{}),this.wSubmit=M(),this.wChange=M(),this.wClick=M(),this.template=b(null,{}),I(()=>{this._form.templatesVersion();let e=this.component().name;this.template.set(e?this._form.getTemplateComponent(e):null)})}hasChildren(){return Array.isArray(this.component().components)}effectiveKey(){let e=this.component().key;if(!e)return null;if(!e.includes("[]"))return e;let t=(this.index()||"").split("_").pop()||"0",n=Number.isFinite(+t)?+t:0;return e.replace(/\[\]/g,`[${n}]`)}get field(){let e=this.fieldTree(),t=this.effectiveKey();return!e||!t?null:e[t]}submit(){this.wSubmit.emit(this.submition()||{})}change(){this.wChange.emit()}click(){this.wClick.emit()}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275cmp=v({type:o,selectors:[["form-component"]],inputs:{index:[1,"index"],formId:[1,"formId"],config:[1,"config"],component:[1,"component"],submition:[1,"submition"],model:[1,"model"],fieldTree:[1,"fieldTree"]},outputs:{wSubmit:"wSubmit",wChange:"wChange",wClick:"wClick"},decls:2,vars:1,consts:[[3,"class"],[1,"wformc"],[3,"class","formId","component","config","submition","model","fieldTree","index"],[3,"wSubmit","wChange","wClick","formId","component","config","submition","model","fieldTree","index"],[4,"ngTemplateOutlet","ngTemplateOutletContext"]],template:function(t,n){t&1&&O(0,xe,3,4,"div",0)(1,Me,2,20,"div",1),t&2&&V(n.hasChildren()?0:n.component().name&&n.template()?1:-1)},dependencies:[o,oe],styles:["[_nghost-%COMP%]{display:block;position:relative}.wformc[_ngcontent-%COMP%]{position:relative;padding:0}.wformc__item[_ngcontent-%COMP%]{display:block;margin:0 0 10px}"],changeDetection:0})}}return o})();var Fe=()=>({}),Se=(o,s)=>s.key??o;function Te(o,s){if(o&1&&(l(0,"h1",0),P(1),p()),o&2){let e=c();h(),Y(e.title)}}function ke(o,s){if(o&1){let e=x();l(0,"form-component",3),C("wSubmit",function(){u(e);let n=c();return f(n.onSubmit())})("wChange",function(){u(e);let n=c();return f(n.onLegacyChange())})("wClick",function(){u(e);let n=c();return f(n.onClick())}),p()}if(o&2){let e=s.$implicit,t=s.$index,n=c(),i=L(0),r=L(1);T(q("wform__component ",n.formId," ",n.formId+"_"+t," ",e.class||"")),g("formId",n.formId)("component",e)("config",i)("submition",r)("model",n.model)("fieldTree",n.fieldTree)("index",""+t)}}var A=(()=>{class o{constructor(){this._core=d($),this._formService=d(E),this.config=a.required({}),this.submition=a({},{}),this.wChange=M(),this.wSubmit=M(),this._components=B(()=>this.config()?.components??[],{}),this.visibleComponents=B(()=>this._components().filter(e=>!e?.hidden),{}),this.instance=b(null,{}),I(()=>{let e=this.config(),t=this.submition();if(!e)return;let n=W(()=>this._formService.form(e,t??void 0));this.instance.set(n)}),I(()=>{let e=this.instance();if(!e)return;let t=e.model();this.wChange.emit(t)})}get formId(){return this.instance()?.id??""}get fieldTree(){return this.instance()?.form??null}get model(){return this.instance()?.model??null}get title(){return this.config()?.title}get cssClass(){return this.config()?.class??""}onSubmit(){let e=this.instance(),t=e?e.model():{};this.wSubmit.emit(t)}onLegacyChange(){let e=this.instance(),t=e?e.model():{};this._core.afterWhile(this,()=>this.wChange.emit(t),150)}onClick(){}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275cmp=v({type:o,selectors:[["wform"]],inputs:{config:[1,"config"],submition:[1,"submition"]},outputs:{wChange:"wChange",wSubmit:"wSubmit"},decls:7,vars:7,consts:[[1,"wform__title"],[1,"wform__body",3,"submit"],[3,"class","formId","component","config","submition","model","fieldTree","index"],[3,"wSubmit","wChange","wClick","formId","component","config","submition","model","fieldTree","index"]],template:function(t,n){if(t&1){let i=x();ee(0)(1),l(2,"div"),O(3,Te,2,1,"h1",0),l(4,"form",1),C("submit",function(m){return u(i),m.preventDefault(),f(n.onSubmit())}),F(5,ke,1,12,"form-component",2,Se),p()()}if(t&2){U(n.config());let i=n.submition();h(),U(i||k(6,Fe)),h(),T(N("wform ",n.cssClass)),h(),V(n.title?3:-1),h(2),S(n.visibleComponents())}},dependencies:[de],styles:[".wform[_ngcontent-%COMP%]{position:relative;display:flex;flex-direction:column;row-gap:12px;width:100%}.wform__title[_ngcontent-%COMP%]{margin:0 0 10px;color:var(--c-text-primary);font-weight:600;font-size:20px;line-height:1.2;letter-spacing:var(--letter-spacing, 0)}.wform__body[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr;gap:12px;width:100%}.wform__component[_ngcontent-%COMP%]{display:block;width:100%}.wform__input[_ngcontent-%COMP%], .wform__textarea[_ngcontent-%COMP%], .wform__select[_ngcontent-%COMP%]{width:100%;display:block;border:1px solid var(--c-border);border-radius:var(--b-radius, 8px);background:transparent;color:var(--c-text-secondary);font-size:var(--fs, 16px);line-height:1.25;padding:10px 12px;transition:var(--transition, .15s ease)}.wform__input[_ngcontent-%COMP%]::placeholder, .wform__textarea[_ngcontent-%COMP%]::placeholder, .wform__select[_ngcontent-%COMP%]::placeholder{color:var(--c-placeholder);transition:inherit}.wform__input[_ngcontent-%COMP%]:focus, .wform__textarea[_ngcontent-%COMP%]:focus, .wform__select[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--c-primary)}.wform__input[_ngcontent-%COMP%]:disabled, .wform__textarea[_ngcontent-%COMP%]:disabled, .wform__select[_ngcontent-%COMP%]:disabled{background:var(--c-grey);border-color:var(--c-grey);color:var(--c-grey);opacity:.6;cursor:default}.wform__textarea[_ngcontent-%COMP%]{min-height:88px;resize:vertical}.wform__select[_ngcontent-%COMP%]{appearance:none;padding-right:30px;position:relative}.wform--two-col[_ngcontent-%COMP%]   .wform__body[_ngcontent-%COMP%]{grid-template-columns:repeat(2,minmax(0,1fr))}@media(max-width:768px){.wform__body[_ngcontent-%COMP%]{grid-template-columns:1fr!important}}"],changeDetection:0})}}return o})();function De(o,s){if(o&1){let e=x();l(0,"wbutton",4),C("wClick",function(){let n=u(e).$implicit,i=c();return f(i.onButtonClick(n))}),P(1),p()}if(o&2){let e=s.$implicit,t=c();g("extraClass","w-btn _primary "+(e.class||""))("disabled",t.submitting()),h(),Z(" ",e.label," ")}}var z=(()=>{class o{constructor(){this._coreService=d($),this.submit=e=>{},this.change=e=>{},this.submitting=b(!1,{})}_sync(e){if(!e)return;this._coreService.copy(e,this.submition);let t=e.data;t&&typeof t=="object"&&(this.submition.data=this.submition.data||{},this._coreService.copy(t,this.submition.data))}handleSubmit(e){this.submitting.set(!0);try{this._sync(e),this.submit(this.submition),this.close()}finally{this.submitting.set(!1)}}handleChange(e){this._sync(e),this.change(this.submition)}onButtonClick(e){this.submitting()||e.click(this.submition,this.close)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275cmp=v({type:o,selectors:[["ng-component"]],decls:5,vars:2,consts:[["formRef",""],[3,"wSubmit","wChange","config","submition"],[1,"modal-actions"],[3,"extraClass","disabled"],[3,"wClick","extraClass","disabled"]],template:function(t,n){if(t&1){let i=x();l(0,"wform",1,0),C("wSubmit",function(m){return u(i),f(n.handleSubmit(m))})("wChange",function(m){return u(i),f(n.handleChange(m))}),p(),l(2,"div",2),F(3,De,2,3,"wbutton",3,Q),p()}t&2&&(g("config",n.form)("submition",n.submition),h(3),S(n.modalButtons))},dependencies:[A,ae],styles:[".modal-actions[_ngcontent-%COMP%]{padding:30px 0 0}.modal-actions[_ngcontent-%COMP%]   .w-btn[_ngcontent-%COMP%]{width:100%;display:block}"],changeDetection:0})}}return o})();var ue=(()=>{class o{constructor(){this._http=d(ie),this.form=a.required({}),this.module=a.required({}),this.field=a.required({}),this.doc=a.required({})}get getDoc(){return this.doc()}change(e){this._http.post(`/api/${this.module()}/unique${this.field()||""}`,this.doc()).subscribe(t=>{this.doc()[this.field()]!==t&&(this.doc()[this.field()]=t)})}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275cmp=v({type:o,selectors:[["ng-component"]],inputs:{form:[1,"form"],module:[1,"module"],field:[1,"field"],doc:[1,"doc"]},decls:1,vars:2,consts:[[3,"wChange","config","submition"]],template:function(t,n){t&1&&(l(0,"wform",0),C("wChange",function(r){return n.change(r)}),p()),t&2&&g("config",n.form())("submition",n.getDoc)},dependencies:[A],encapsulation:2,changeDetection:0})}}return o})();var E=(()=>{class o{constructor(){this._modalService=d(le),this._storeService=d(re),this._injector=d(K),this.appId=ce.appId,this._templateComponent=new Map,this.templatesVersion=b(0,{}),this.templateFields={},this.customTemplateFields={},this.forms=[],this.formIds=[],this._signalForms=new Map,this._storeService.getJson("formIds",e=>{Array.isArray(e)&&this.formIds.push(...e)})}addTemplateComponent(e,t){this._templateComponent.has(e)||(this._templateComponent.set(e,t),this.templatesVersion.update(n=>n+1))}removeTemplateComponent(e){this._templateComponent.delete(e)&&this.templatesVersion.update(t=>t+1)}getTemplateComponent(e){return this._templateComponent.get(e)??null}getTemplateComponentsNames(){return Array.from(this._templateComponent.keys())}getTemplateFields(e){return this.templateFields[e]||["Placeholder","Label"]}setTemplateFields(e,t,n={}){this.templateFields[e]=t,this.customTemplateFields[e]=y(y({},this.customTemplateFields[e]||{}),n)}getCustomTemplateFields(e){return this.customTemplateFields[e]||{}}getDefaultForm(e,t=["name","description"]){this._rememberFormId(e);let n=t.map((i,r)=>{let m=i.includes(".")?i.split(".")[1]:"Text",_=(i.split(".")[0]||i).replace(/\[\]|\[\d+\]/g,"");return{name:m,key:i,focused:r===0,props:{placeholder:`Enter your ${_}`,label:_.charAt(0).toUpperCase()+_.slice(1)}}});return{formId:e,components:n}}form(e,t){let n=e.formId||crypto.randomUUID();e.formId=n,this._rememberFormId(n);let i=this._signalForms.get(n);if(i)return t&&Object.keys(t).length&&i.model.update(D=>y(y({},D),t)),i;let r=this._buildInitialModel(e,t??{}),m=b(r,{}),_=H(this._injector,()=>se(m,D=>{this._applyValidators(D,e)})),w={id:n,model:m,form:_};return this._signalForms.set(n,w),w}_buildInitialModel(e,t={}){let n=y({},t);return this._traverseComponents(e.components,i=>{i.key&&(i.key in n||(n[i.key]=null))}),n}_applyValidators(e,t){this._traverseComponents(t.components,n=>{if(!n.key)return;let i=e[n.key];if(!i)return;let r=n.props?.label??n.key;n.required&&me(i,{message:`${r} is required`})})}_traverseComponents(e,t){if(e?.length)for(let n of e)t(n),n.components?.length&&this._traverseComponents(n.components,t)}modal(e,t=[],n={data:{}},i=m=>{},r={}){return(Array.isArray(e)?e:[e]).forEach(_=>this.form(_,n)),new Promise(_=>{this._modalService.show(J(y({},r),{component:z,class:"forms_modalService",size:"big",form:e,modalButtons:Array.isArray(t)?t:[t],submition:n,onClose:()=>_(n),submit:w=>_(w),change:w=>{typeof i=="function"&&i(w)}}))})}modalDocs(e,t="Modify content of documents"){return new Promise(n=>{let i={docs:JSON.stringify(e.length?e:[],null,4)};this._modalService.show({component:z,class:"forms_modalService",size:"big",submition:i,form:{title:t,components:[{name:"Ace",key:"docs",props:{placeholder:"Fill content of documents..."}}]},modalButtons:[{label:"Update",click:()=>{let r=i.docs?JSON.parse(i.docs):[];n(r)}}]})})}modalUnique(e,t,n,i="",r=()=>{}){let m=this.getDefaultForm("unique",[t+(i?"."+i:"")]);this.form(m,n),this._modalService.show({component:ue,form:m,module:e,field:t,doc:n,class:"forms_modalService",onClose:r})}getComponent(e,t){return this._getComponent(e.components,t)||{}}getProp(e,t,n){return this.getComponent(e,t)?.props?.[n]??null}setProp(e,t,n,i){let r=this.getComponent(e,t);r&&(r.props=r.props||{},r.props[n]=i)}_getComponent(e=[],t){for(let n of e||[]){if(n.key===t)return n;if(n.components?.length){let i=this._getComponent(n.components,t);if(i)return i}}return null}_rememberFormId(e){e&&(this.formIds.includes(e)||(this.formIds.push(e),this._storeService.setJson("formIds",this.formIds)))}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=R({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();export{E as a};
