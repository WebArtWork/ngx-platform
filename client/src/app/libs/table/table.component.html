<div
	class="wtable w-full max-w-full mx-auto rounded-[var(--b-radius-card,10px)] bg-[var(--c-bg-secondary)] shadow-[var(--c-shadow)] overflow-hidden"
>
	<!-- Header -->
	<div
		class="wtable__header px-3 py-3 sm:px-4 border-b border-[var(--c-border)]"
	>
		<div
			class="wtable__header-main flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-3"
		>
			<h3
				class="wtable__title m-0 font-semibold text-[var(--c-text-primary)]"
			>
				{{ title() }}
			</h3>

			@if (headerTpl()) {
			<div class="wtable__header-slot min-w-0 sm:min-w-[220px]">
				<ng-container
					[ngTemplateOutlet]="headerTpl()?.template"
				></ng-container>
			</div>
			}

			<!-- Search (desktop/tablet) -->
			@if (config().searchable) {
			<div class="flex-1 min-w-0 sm:mx-3">
				<div
					class="wtable__search relative flex items-center"
					[class.wtable__search--active]="searchShow"
				>
					<input
						class="wtable__search-input w-full h-11 rounded-md px-3 pr-11 bg-[var(--c-bg-secondary)] text-[var(--c-text-primary)] border border-[var(--c-border)] focus:outline-none focus:ring-2 focus:ring-[var(--focus-ring)] focus:border-[var(--c-primary)]"
						type="text"
						placeholder="Search..."
						[(ngModel)]="searching_text"
						(ngModelChange)="searching()"
						(keyup.enter)="search(); searchShow = false"
					/>
					<button
						type="button"
						class="wtable__search-btn absolute right-1 top-1/2 -translate-y-1/2 inline-flex items-center justify-center h-9 w-9 rounded-md hover:bg-black/5"
						(click)="search(); searchShow = false"
						aria-label="Search"
					>
						<span
							class="material-icons material-symbols-outlined wtable__search-icon"
						>
							search
						</span>
					</button>
				</div>
			</div>
			}

			<!-- Header actions -->
			<div
				class="wtable__header-actions flex items-center gap-2 sm:ml-auto"
			>
				@if (config().headerButtons) { @for (button of
				config().headerButtons; track button) { @if (button) {
				<wbutton
					class="wtable__header-button"
					[disableSubmit]="true"
					[extraClass]="
						'wtable__header-button-inner inline-flex items-center justify-center h-11 min-w-[44px] px-2 ' +
						(button.class || '')
					"
					(wClick)="button.click()"
				>
					@if (button.icon) {
					<i class="material-icons" [title]="button.icon">
						{{ button.icon }}
					</i>
					} @if (button.text) {
					<span class="whitespace-nowrap">{{ button.text }}</span>
					}
				</wbutton>
				} } } @if (config().create) {
				<wbutton
					class="wtable__header-button"
					[disableSubmit]="true"
					[extraClass]="
						'wtable__header-button-inner inline-flex items-center justify-center h-11 min-w-[44px] px-2'
					"
					(wClick)="config().create()"
				>
					<i class="material-icons" title="Add"> add </i>
				</wbutton>
				}
			</div>
		</div>
	</div>

	<!-- Table -->
	<div class="w-full overflow-x-auto">
		<table
			class="wtable__table w-full border-collapse"
			cellpadding="0"
			cellspacing="0"
		>
			<thead class="wtable__thead">
				<tr>
					@if (config().num) {
					<th scope="col" class="wtable__th">No.</th>
					} @for (column of columns(); track column) {
					<th scope="col" class="wtable__th">
						<div
							class="wtable__sort inline-flex items-center gap-2 relative select-none"
							[class.is-activeDown]="
								sort_type.direction === 'desc' &&
								column.field === sort_type.title
							"
							[class.is-activeUp]="
								sort_type.direction === 'asc' &&
								column.field === sort_type.title
							"
							(click)="sort(column)"
						>
							<span class="truncate">{{ column.title }}</span>

							@if (sortable[column.field]) {
							<span class="material-icons wtable__sort-icon">
								keyboard_backspace
							</span>
							}
						</div>
					</th>
					} @if (config().delete || config().update ||
					config().buttons?.length) {
					<th scope="col" class="wtable__th wtable__th--actions">
						@if (action) {
						<ng-container
							*ngTemplateOutlet="action.template"
						></ng-container>
						} @else { Actions }
					</th>
					}
				</tr>
			</thead>

			<tbody class="wtable__tbody">
				@let _cfg = config(); @for (row of _cfg.allDocs ?
				paginatedRows() : normalizedRows(); track row[bindValue()] ) {
				<tr class="wtable__tr">
					@if (_cfg.num) {
					<td class="wtable__td">{{ row.num }}</td>
					} @for (column of columns(); track column) { @if
					(custom_cell[column.field]) {
					<td
						class="wtable__td"
						[attr.data-label]="column.title + ': '"
					>
						<ng-container
							*ngTemplateOutlet="custom_cell[column.field]; context: { $implicit: row }"
						></ng-container>
					</td>
					} @else {
					<td
						class="wtable__td"
						[attr.data-label]="column.title + ': '"
					>
						{{ row[column.field] }}
					</td>
					} } @if (_cfg.delete || _cfg.update || _cfg.buttons?.length)
					{
					<td
						class="wtable__td wtable__cell--actions"
						data-label="Actions: "
					>
						<div
							class="wtable__actions inline-flex items-center gap-2"
						>
							@for (button of _cfg.buttons || []; track button) {
							@if (button) { @if (!button.ahref &&
							!button.ahrefFunc && !button.href &&
							!button.hrefFunc) {
							<i
								class="material-icons wtable__action-icon"
								[title]="button.icon"
								(click)="button.click(row)"
							>
								{{ button.icon }}
							</i>
							} @if (button.ahref) {
							<a
								[href]="button.ahref"
								[target]="button.target || '_blank'"
								class="inline-flex"
							>
								<i
									class="material-icons wtable__action-icon"
									[title]="button.icon"
								>
									{{ button.icon }}
								</i>
							</a>
							} @if (button.ahrefFunc) {
							<a
								[href]="button.ahrefFunc(row)"
								[target]="button.target || '_blank'"
								class="inline-flex"
							>
								<i
									class="material-icons wtable__action-icon"
									[title]="button.icon"
								>
									{{ button.icon }}
								</i>
							</a>
							} @if (button.href) {
							<a [routerLink]="button.href" class="inline-flex">
								<i
									class="material-icons wtable__action-icon"
									[title]="button.icon"
								>
									{{ button.icon }}
								</i>
							</a>
							} @if (button.hrefFunc) {
							<a
								[routerLink]="button.hrefFunc(row)"
								class="inline-flex"
							>
								<i
									class="material-icons wtable__action-icon"
									[title]="button.icon"
								>
									{{ button.icon }}
								</i>
							</a>
							} } } @if (_cfg.update) {
							<i
								class="material-icons wtable__action-icon"
								title="Edit"
								(click)="_cfg.update(row)"
							>
								edit
							</i>
							} @if (_cfg.delete) {
							<i
								class="material-icons wtable__action-icon"
								title="Delete"
								(click)="_cfg.delete(row)"
							>
								delete_outline
							</i>
							}
						</div>
					</td>
					}
				</tr>
				}
			</tbody>

			@if (_cfg.perPage || (_cfg.formCreate && _cfg.create)) {
			<tfoot class="wtable__tfoot">
				<tr>
					<td
						[attr.colspan]="
							columns().length +
							(config().delete ||
							config().update ||
							config().buttons?.length
								? 1
								: 0)
						"
					>
						<div
							class="wtable__footer flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between"
						>
							@if (_cfg.perPage) {
							<div
								class="wtable__perpage flex items-center flex-wrap gap-x-2 gap-y-1 text-xs text-[var(--c-text-secondary)]"
							>
								<div class="wtable__perpage-text">
									Showing items per page
								</div>

								<div
									class="wtable__perpage-dropdown"
									[class.open]="select_page_size"
									(clickOutside)="select_page_size = false"
								>
									<div
										class="caption"
										(click)="select_page_size = !select_page_size"
									>
										{{ _cfg.perPage === -1 ? 'All' :
										_cfg.perPage }}
									</div>

									<div class="list">
										@for (pageSize of _cfg.pageSizeOptions;
										track pageSize) {
										<div class="item">
											<div
												[class.selected]="_cfg.perPage === pageSize"
												(click)="changePerPage(pageSize)"
											>
												{{ pageSize }}
											</div>
										</div>
										} @if (_cfg.allDocs) {
										<div class="item">
											<div
												[class.selected]="_cfg.perPage === -1"
												(click)="changePerPage(-1)"
											>
												All
											</div>
										</div>
										}
									</div>
								</div>

								@if (_cfg.perPage >= 0 && !_cfg.allDocs) {
								<div class="wtable__perpage-result">
									Page {{ _cfg.page }}
								</div>
								} @if (_cfg.perPage >= 0 && _cfg.allDocs) {
								<div class="wtable__perpage-result">
									<span>
										{{ ((_cfg.page - 1) * _cfg.perPage) + 1
										}} - {{ (_cfg.page * _cfg.perPage >
										totalCount() && totalCount()) ||
										(_cfg.page * _cfg.perPage) }}
									</span>
									<span> of </span>
									<span>{{ totalCount() }}</span>
								</div>
								}
							</div>
							}

							<!-- Pagination -->
							@if (_cfg.perPage !== -1 && _cfg.allDocs) {
							<div
								class="wtable__pagination inline-flex items-center gap-2 sm:ml-auto"
							>
								<wbutton
									[extraClass]="'wtable__arrow-btn inline-flex items-center justify-center h-9 w-9 p-0'"
									[isMultipleClicksAllowed]="true"
									[disabled]="_cfg.page === 1"
									(wClick)="firstPage()"
								>
									<span class="material-icons"
										>keyboard_double_arrow_left</span
									>
								</wbutton>

								<wbutton
									[extraClass]="'wtable__arrow-btn inline-flex items-center justify-center h-9 w-9 p-0'"
									[isMultipleClicksAllowed]="true"
									[disabled]="_cfg.page === 1"
									(wClick)="previous()"
								>
									<span class="material-icons"
										>chevron_left</span
									>
								</wbutton>

								<wbutton
									[extraClass]="'wtable__arrow-btn inline-flex items-center justify-center h-9 w-9 p-0'"
									[isMultipleClicksAllowed]="true"
									[disabled]="_cfg.page * _cfg.perPage > totalCount()"
									(wClick)="next()"
								>
									<span class="material-icons"
										>chevron_right</span
									>
								</wbutton>

								<wbutton
									[extraClass]="'wtable__arrow-btn inline-flex items-center justify-center h-9 w-9 p-0'"
									[isMultipleClicksAllowed]="true"
									[disabled]="isLast()"
									(wClick)="lastPage()"
								>
									<span class="material-icons"
										>keyboard_double_arrow_right</span
									>
								</wbutton>
							</div>
							} @if (!_cfg.allDocs) {
							<div
								class="wtable__pagination inline-flex items-center gap-2 sm:ml-auto"
							>
								<wbutton
									[extraClass]="'wtable__arrow-btn inline-flex items-center justify-center h-9 w-9 p-0'"
									[isMultipleClicksAllowed]="true"
									[disabled]="_cfg.page === 1"
									(wClick)="previous()"
								>
									<span class="material-icons"
										>chevron_left</span
									>
								</wbutton>

								<wbutton
									[extraClass]="'wtable__arrow-btn inline-flex items-center justify-center h-9 w-9 p-0'"
									[disabled]="normalizedRows().length !== _cfg.perPage"
									[isMultipleClicksAllowed]="true"
									(wClick)="next()"
								>
									<span class="material-icons"
										>chevron_right</span
									>
								</wbutton>
							</div>
							}
						</div>
					</td>
				</tr>
			</tfoot>
			}
		</table>
	</div>
</div>
